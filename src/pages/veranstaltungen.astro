---
import Layout from '../layouts/Layout.astro';
import CalendarSubscription from '../components/CalendarSubscription.astro';
import { parse, isPast, startOfDay } from 'date-fns';
import { veranstaltungen } from '../data/veranstaltungen';

function parseDate(dateString: string) {
  const [day, month, year] = dateString.split('.').map(x => parseInt(x));
  return new Date(year, month - 1, day).getTime();
}

const sortedEvents = [...veranstaltungen].sort((a, b) => parseDate(a.datum) - parseDate(b.datum));

const today = startOfDay(new Date());
const upcomingEvents = sortedEvents.filter((item) => {
  const date = parse(item.datum, "dd.MM.yyyy", new Date());
  return !isPast(startOfDay(date)) || startOfDay(date).getTime() === today.getTime();
});
const pastEvents = sortedEvents.filter((item) => {
  const date = parse(item.datum, "dd.MM.yyyy", new Date());
  return isPast(startOfDay(date)) && startOfDay(date).getTime() !== today.getTime();
});
---

<Layout
  title="Veranstaltungen"
  teaserImage="/images/veranstaltungen.jpg"
  teaserPosition="50% 38%"
  teaserAltText="Willkommen beim Obst- und Gartenbauverein Pattenhofen Altenthann e.V."
>
  <h1>Jahresprogramm 2026</h1>
  {upcomingEvents.length > 0 && (
    <table>
      {upcomingEvents.map((event) => (
        <tr>
          <td style="white-space: nowrap; vertical-align: top;">
            {event.datum}
          </td>
          <td>{event.titel}</td>
        </tr>
      ))}
    </table>
  )}

  {pastEvents.length > 0 && (
    <div class="past-events-section">
      <button id="togglePastEvents" class="toggle-button">
        Vergangene Veranstaltungen anzeigen
      </button>

      <table id="pastEvents" class="hidden">
        {pastEvents.map((event) => (
          <tr>
            <td style="white-space: nowrap; vertical-align: top;">
              {event.datum}
            </td>
            <td>{event.titel}</td>
          </tr>
        ))}
      </table>
    </div>
  )}

  <p>
    Weitere Veranstaltungen die noch nicht terminiert sind werden rechtzeitig in
    der Tageszeitung ver√∂ffentlicht.
  </p>

  <CalendarSubscription icsUrl="/veranstaltungen.ics" />
</Layout>

<style lang="scss">
  @use "../styles/minima/variables" as *;

  .past-events-section {
    margin-top: $spacing-unit;
  }

  .toggle-button {
    padding: 8px 16px;
    background-color: $grey-color-light;
    border: 1px solid $grey-color;
    border-radius: 4px;
    color: $text-color;
    font-size: $base-font-size;
    font-weight: 500;
    cursor: pointer;

    &:hover {
      background-color: $grey-color;
      color: #fff;
    }
  }

  .hidden {
    display: none;
  }

  #pastEvents {
    opacity: 0.6;
  }
</style>

<script>
  const toggleButton = document.getElementById("togglePastEvents");
  const pastEventsContainer = document.getElementById("pastEvents");

  if (toggleButton && pastEventsContainer) {
    toggleButton.addEventListener("click", () => {
      const isHidden = pastEventsContainer.classList.contains("hidden");

      if (isHidden) {
        pastEventsContainer.classList.remove("hidden");
        toggleButton.textContent = "Vergangene Veranstaltungen verbergen";
      } else {
        pastEventsContainer.classList.add("hidden");
        toggleButton.textContent = "Vergangene Veranstaltungen anzeigen";
      }
    });
  }
</script>
